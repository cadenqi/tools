<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>皮带张力检测工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a5276;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --border-radius: 16px;
            --header-height: 64px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: var(--dark);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding-top: var(--header-height);
            overflow-x: hidden;
        }
        
        /* 固定顶部导航 */
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--header-height);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 1.3rem;
        }
        
        .logo i {
            font-size: 1.6rem;
        }
        
        .header-controls {
            display: flex;
            gap: 15px;
        }
        
        .icon-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        /* 主容器 */
        .container {
            max-width: 100%;
            padding: 20px;
            margin: 0 auto;
        }
        
        /* 卡片样式 */
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:last-child {
            margin-bottom: 0;
        }
        
        .card h2 {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }
        
        .card h2 i {
            color: var(--secondary);
        }
        
        /* 测量控制区域 */
        .measure-control {
            text-align: center;
        }
        
        /* 圆形测量按钮 */
        .measure-button-container {
            display: flex;
            justify-content: center;
            margin: 25px 0;
        }
        
        .measure-button {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), #2980b9);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .measure-button:active {
            transform: scale(0.95);
        }
        
        .measure-button.recording {
            background: linear-gradient(135deg, var(--danger), #c0392b);
            animation: pulse 1.5s infinite;
        }
        
        .measure-button i {
            font-size: 2.5rem;
            margin-bottom: 5px;
        }
        
        .measure-button-text {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .progress-ring {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            fill: none;
            stroke: rgba(255, 255, 255, 0.3);
            stroke-width: 4;
            stroke-dasharray: 440;
            stroke-dashoffset: 440;
            transition: stroke-dashoffset 0.3s;
        }
        
        /* 结果展示 */
        .result-card {
            text-align: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .result-value {
            font-size: 2.8rem;
            font-weight: 700;
            color: var(--secondary);
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .result-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .detail-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .detail-label {
            font-size: 0.85rem;
            color: #7f8c8d;
        }
        
        .detail-value {
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 5px;
            color: var(--primary);
        }
        
        /* 测量记录 */
        .records-container {
            margin-top: 20px;
        }
        
        .records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .records-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .record-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: relative;
        }
        
        .record-frequency {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .record-tension {
            font-size: 0.9rem;
            color: var(--secondary);
            margin-top: 5px;
        }
        
        .record-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: #7f8c8d;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .record-delete:hover {
            color: var(--danger);
        }
        
        .average-result {
            margin-top: 20px;
            padding: 15px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            text-align: center;
        }
        
        .average-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 5px;
        }
        
        /* 频谱图 */
        #frequencyCanvas {
            width: 100%;
            height: 180px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-top: 15px;
        }
        
        /* 状态指示 */
        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            background: #f8f9fa;
            font-size: 0.95rem;
        }
        
        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: var(--danger);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .modal h3 {
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 1.3rem;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-buttons .btn {
            flex: 1;
            padding: 12px;
        }
        
        /* 表单元素 */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        /* 按钮样式 */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: var(--secondary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-success:hover {
            background: #219653;
        }
        
        /* 响应式调整 */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .result-details {
                grid-template-columns: 1fr;
            }
            
            .records-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .result-value {
                font-size: 2.2rem;
            }
            
            .measure-button {
                width: 120px;
                height: 120px;
            }
            
            .measure-button i {
                font-size: 2rem;
            }
        }
        
        @media (max-width: 360px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 12px;
            }
            
            .measure-button {
                width: 100px;
                height: 100px;
            }
            
            .measure-button i {
                font-size: 1.8rem;
            }
            
            .result-value {
                font-size: 2rem;
            }
            
            .records-grid {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- 固定顶部导航 -->
    <header>
        <div class="logo">
            <i class="fas fa-wave-square"></i>
            <span>张力检测</span>
        </div>
        <div class="header-controls">
            <button class="icon-btn" id="settingsBtn">
                <i class="fas fa-cog"></i>
            </button>
            <button class="icon-btn" id="infoBtn">
                <i class="fas fa-info"></i>
            </button>
        </div>
    </header>

    <!-- 主容器 -->
    <div class="container">
        <!-- 测量控制卡片 -->
        <div class="card measure-control">
            <h2><i class="fas fa-sliders-h"></i> 测量控制</h2>
            
            <!-- 状态指示器 -->
            <div class="status-indicator">
                <div id="resultStatus">准备测量皮带张力 - 轻敲皮带并转动车轮</div>
            </div>
            
            <div class="measure-button-container">
                <div class="measure-button" id="measureButton">
                    <svg class="progress-ring" width="140" height="140">
                        <circle class="progress-ring-circle" stroke="white" stroke-width="4" fill="transparent" r="65" cx="70" cy="70"/>
                    </svg>
                    <i class="fas fa-microphone"></i>
                    <div class="measure-button-text">开始测量</div>
                </div>
            </div>
            
            <div style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                提示：轻敲皮带中央，工具会自动检测振动频率
            </div>
        </div>
        
        <!-- 结果展示卡片 -->
        <div class="card result-card">
            <h2><i class="fas fa-chart-line"></i> 最新测量结果</h2>
            <div id="resultValue" class="result-value">--</div>
            <div id="resultDetails" class="result-details" style="display: none;">
                <div class="detail-item">
                    <div class="detail-label">检测频率</div>
                    <div id="frequencyValue" class="detail-value">-- Hz</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">皮带张力</div>
                    <div id="tensionValue" class="detail-value">-- kg</div>
                </div>
            </div>
        </div>
        
        <!-- 测量记录卡片 -->
        <div class="card">
            <h2><i class="fas fa-history"></i> 测量记录</h2>
            
            <div class="records-container">
                <div class="records-header">
                    <span>已记录 <span id="recordCount">0</span> 次测量</span>
                    <button id="clearRecords" class="btn btn-danger" style="padding: 8px 12px; font-size: 0.9rem;">
                        <i class="fas fa-trash"></i> 清空记录
                    </button>
                </div>
                
                <div id="recordsGrid" class="records-grid">
                    <!-- 测量记录将动态添加到这里 -->
                </div>
                
                <div id="averageResult" class="average-result" style="display: none;">
                    <div>平均张力</div>
                    <div id="averageValue" class="average-value">-- kg</div>
                </div>
            </div>
        </div>
        
        <!-- 频谱图卡片 -->
        <div class="card">
            <h2><i class="fas fa-waveform"></i> 频率频谱</h2>
            <canvas id="frequencyCanvas"></canvas>
        </div>
    </div>
    
    <!-- 参数设置模态框 -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-cog"></i> 参数设置</h3>
            
            <div class="form-group">
                <label for="spanLength">跨度长度 (mm)</label>
                <input type="number" id="spanLength" value="800" step="1" min="100">
                <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                    皮带在两个皮带轮之间的自由振动长度
                </div>
            </div>
            
            <div class="form-group">
                <label for="massDensity">线性密度 (kg/m)</label>
                <input type="number" id="massDensity" value="0.01" step="0.001" min="0.001">
                <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                    自行车同步带通常为 0.01-0.02 kg/m
                </div>
            </div>
            
            <div class="form-group">
                <label for="sensitivity">检测灵敏度</label>
                <select id="sensitivity">
                    <option value="low">低灵敏度（更抗干扰）</option>
                    <option value="medium" selected>中灵敏度</option>
                    <option value="high">高灵敏度（更敏感）</option>
                </select>
            </div>
            
            <div class="modal-buttons">
                <button id="cancelSettings" class="btn btn-danger">取消</button>
                <button id="saveSettings" class="btn btn-success">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 信息模态框 -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-info-circle"></i> 工具原理</h3>
            
            <div style="margin-bottom: 20px;">
                <h4>物理原理</h4>
                <p>皮带张力检测基于弦振动理论：</p>
                <p style="text-align: center; font-weight: bold; margin: 10px 0; background: #f8f9fa; padding: 10px; border-radius: 8px;">
                    T = 4 × μ × (L/1000)² × f²
                </p>
                <p>其中：</p>
                <ul>
                    <li><strong>T</strong> - 皮带张力 (N)</li>
                    <li><strong>μ</strong> - 皮带线性密度 (kg/m)</li>
                    <li><strong>L</strong> - 皮带跨度长度 (mm)</li>
                    <li><strong>f</strong> - 振动频率 (Hz)</li>
                </ul>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h4>音频过滤技术</h4>
                <p>工具使用以下方法过滤杂音：</p>
                <ul>
                    <li>限制分析频率范围：5-100Hz（皮带振动特征频率）</li>
                    <li>设置振幅阈值，只记录明显振动信号</li>
                    <li>检测特定频率模式，识别皮带振动特征</li>
                </ul>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h4>使用方法</h4>
                <ol>
                    <li>设置正确的皮带参数（长度和密度）</li>
                    <li>点击"开始测量"按钮</li>
                    <li>轻敲皮带中央使其振动</li>
                    <li>工具自动检测频率并计算张力</li>
                    <li>重复测量4次，查看平均值</li>
                </ol>
            </div>
            
            <div class="modal-buttons">
                <button id="closeInfo" class="btn btn-success">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 权限请求模态框 -->
    <div id="permissionModal" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-microphone"></i> 麦克风权限请求</h3>
            <p>皮带张力检测工具需要访问您的麦克风以测量皮带振动频率。</p>
            <p>请点击"允许"以继续使用本应用。</p>
            <div class="modal-buttons">
                <button id="denyPermission" class="btn btn-danger">拒绝</button>
                <button id="grantPermission" class="btn btn-success">允许</button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let audioContext;
        let analyser;
        let microphone;
        let scriptProcessor;
        let isRecording = false;
        const sampleRate = 44100;
        const fftSize = 4096;
        let permissionRequested = false;
        let measurementRecords = JSON.parse(localStorage.getItem('tensionRecords')) || [];
        
        // 皮带振动特征频率范围 (Hz)
        const MIN_FREQUENCY = 5;
        const MAX_FREQUENCY = 100;
        
        // DOM元素
        const measureButton = document.getElementById('measureButton');
        const resultStatus = document.getElementById('resultStatus');
        const resultValue = document.getElementById('resultValue');
        const resultDetails = document.getElementById('resultDetails');
        const frequencyValue = document.getElementById('frequencyValue');
        const tensionValue = document.getElementById('tensionValue');
        const canvas = document.getElementById('frequencyCanvas');
        const canvasCtx = canvas.getContext('2d');
        const permissionModal = document.getElementById('permissionModal');
        const grantPermissionBtn = document.getElementById('grantPermission');
        const denyPermissionBtn = document.getElementById('denyPermission');
        const recordsGrid = document.getElementById('recordsGrid');
        const clearRecordsBtn = document.getElementById('clearRecords');
        const recordCount = document.getElementById('recordCount');
        const averageResult = document.getElementById('averageResult');
        const averageValue = document.getElementById('averageValue');
        const progressCircle = document.querySelector('.progress-ring-circle');
        const settingsModal = document.getElementById('settingsModal');
        const infoModal = document.getElementById('infoModal');
        const settingsBtn = document.getElementById('settingsBtn');
        const infoBtn = document.getElementById('infoBtn');
        const cancelSettings = document.getElementById('cancelSettings');
        const saveSettings = document.getElementById('saveSettings');
        const closeInfo = document.getElementById('closeInfo');
        
        // 参数设置
        let spanLength = 800; // mm
        let massDensity = 0.01; // kg/m
        let sensitivity = 'medium';
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            setupCanvas();
            setupEventListeners();
            updateRecordList();
            loadSettings();
        });
        
        // 设置Canvas尺寸
        function setupCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvasCtx.scale(dpr, dpr);
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 测量按钮事件
            measureButton.addEventListener('click', function() {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            });
            
            // 权限模态框按钮
            grantPermissionBtn.addEventListener('click', () => {
                permissionModal.style.display = 'none';
                permissionRequested = true;
                startRecording();
            });
            
            denyPermissionBtn.addEventListener('click', () => {
                permissionModal.style.display = 'none';
                resultStatus.textContent = '需要麦克风权限才能进行测量';
                resultStatus.style.color = 'var(--danger)';
                permissionRequested = true;
            });
            
            // 清空记录按钮
            clearRecordsBtn.addEventListener('click', clearRecords);
            
            // 设置和信息按钮
            settingsBtn.addEventListener('click', () => {
                settingsModal.style.display = 'flex';
            });
            
            infoBtn.addEventListener('click', () => {
                infoModal.style.display = 'flex';
            });
            
            // 模态框关闭按钮
            cancelSettings.addEventListener('click', () => {
                settingsModal.style.display = 'none';
            });
            
            saveSettings.addEventListener('click', saveSettingsHandler);
            
            closeInfo.addEventListener('click', () => {
                infoModal.style.display = 'none';
            });
            
            // 窗口调整大小时重置Canvas
            window.addEventListener('resize', setupCanvas);
            
            // 点击模态框外部关闭
            window.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    settingsModal.style.display = 'none';
                }
                if (e.target === infoModal) {
                    infoModal.style.display = 'none';
                }
                if (e.target === permissionModal) {
                    permissionModal.style.display = 'none';
                }
            });
        }
        
        // 加载设置
        function loadSettings() {
            const savedSettings = JSON.parse(localStorage.getItem('tensionSettings'));
            if (savedSettings) {
                spanLength = savedSettings.spanLength || 800;
                massDensity = savedSettings.massDensity || 0.01;
                sensitivity = savedSettings.sensitivity || 'medium';
                
                document.getElementById('spanLength').value = spanLength;
                document.getElementById('massDensity').value = massDensity;
                document.getElementById('sensitivity').value = sensitivity;
            }
        }
        
        // 保存设置
        function saveSettingsHandler() {
            spanLength = parseFloat(document.getElementById('spanLength').value);
            massDensity = parseFloat(document.getElementById('massDensity').value);
            sensitivity = document.getElementById('sensitivity').value;
            
            if (!spanLength || spanLength <= 0) {
                alert('请输入有效的跨度长度（大于0）');
                return;
            }
            
            if (!massDensity || massDensity <= 0) {
                alert('请输入有效的线性密度（大于0）');
                return;
            }
            
            const settings = {
                spanLength: spanLength,
                massDensity: massDensity,
                sensitivity: sensitivity
            };
            
            localStorage.setItem('tensionSettings', JSON.stringify(settings));
            settingsModal.style.display = 'none';
            
            alert('设置已保存！');
        }
        
        // 开始录制
        async function startRecording() {
            try {
                // 请求麦克风权限并创建音频上下文
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // 只在未请求过权限时显示模态框
                if (!permissionRequested) {
                    if (navigator.permissions) {
                        const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
                        
                        if (permissionStatus.state === 'prompt') {
                            permissionModal.style.display = 'flex';
                            return;
                        } else if (permissionStatus.state === 'denied') {
                            showError('麦克风访问被拒绝。请在浏览器设置中允许麦克风权限。');
                            permissionRequested = true;
                            return;
                        }
                    } else {
                        permissionModal.style.display = 'flex';
                        return;
                    }
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false,
                        sampleRate: sampleRate
                    } 
                });
                
                // 创建分析节点
                microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = fftSize;
                analyser.smoothingTimeConstant = 0.3; // 降低平滑系数以提高响应速度
                
                // 创建脚本处理器用于处理音频数据
                scriptProcessor = audioContext.createScriptProcessor(fftSize, 1, 1);
                
                // 连接节点
                microphone.connect(analyser);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);
                
                // 设置音频处理回调
                let isDetecting = false;
                let detectionStartTime = 0;
                const DETECTION_TIMEOUT = 2000; // 检测超时时间（毫秒）
                
                scriptProcessor.onaudioprocess = (e) => {
                    if (isRecording) {
                        // 实时绘制频谱
                        drawRealTimeSpectrum();
                        
                        // 检测皮带振动
                        if (!isDetecting) {
                            const frequency = detectBeltVibration();
                            if (frequency) {
                                isDetecting = true;
                                detectionStartTime = Date.now();
                                resultStatus.innerHTML = '<span class="recording-indicator"></span> 检测到皮带振动...';
                            }
                        } else {
                            // 正在检测中，检查是否超时
                            if (Date.now() - detectionStartTime > DETECTION_TIMEOUT) {
                                isDetecting = false;
                                resultStatus.textContent = '检测超时，请重试';
                            }
                            
                            // 持续检测频率
                            const frequency = detectBeltVibration();
                            if (frequency) {
                                // 检测到稳定的频率，停止检测并记录结果
                                isDetecting = false;
                                stopRecording();
                                processMeasurement(frequency);
                            }
                        }
                    }
                };
                
                // 开始录制
                isRecording = true;
                measureButton.classList.add('recording');
                measureButton.querySelector('.measure-button-text').textContent = '停止检测';
                resultStatus.innerHTML = '<span class="recording-indicator"></span> 正在检测皮带振动...';
                resultValue.textContent = '--';
                resultDetails.style.display = 'none';
                
            } catch (err) {
                console.error('录音错误:', err);
                let errorMessage = '无法访问麦克风: ';
                
                if (err.name === 'NotAllowedError') {
                    errorMessage += '权限被拒绝。';
                    if (!permissionRequested) {
                        permissionModal.style.display = 'flex';
                    } else {
                        errorMessage += '请在浏览器设置中允许麦克风访问。';
                    }
                } else if (err.name === 'NotFoundError') {
                    errorMessage += '未找到麦克风设备。请检查设备连接。';
                } else if (err.name === 'NotSupportedError') {
                    errorMessage += '浏览器不支持音频录制功能。';
                } else {
                    errorMessage += err.message;
                }
                
                showError(errorMessage);
                permissionRequested = true;
            }
        }
        
        // 检测皮带振动
        function detectBeltVibration() {
            if (!analyser) return null;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            // 计算频率分辨率
            const freqResolution = sampleRate / analyser.frequencyBinCount;
            
            // 只分析皮带振动特征频率范围
            const minIndex = Math.floor(MIN_FREQUENCY / freqResolution);
            const maxIndex = Math.floor(MAX_FREQUENCY / freqResolution);
            
            // 寻找最大幅度的频率
            let maxMag = 0;
            let maxIndex = 0;
            
            for (let i = minIndex; i < Math.min(maxIndex, dataArray.length); i++) {
                if (dataArray[i] > maxMag) {
                    maxMag = dataArray[i];
                    maxIndex = i;
                }
            }
            
            // 根据灵敏度设置阈值
            let threshold;
            switch(sensitivity) {
                case 'low':
                    threshold = 100;
                    break;
                case 'high':
                    threshold = 50;
                    break;
                default: // medium
                    threshold = 70;
            }
            
            // 只有幅度足够大的频率才被认为是有效信号
            if (maxMag > threshold) {
                const frequency = maxIndex * freqResolution;
                return frequency;
            }
            
            return null;
        }
        
        // 处理测量结果
        function processMeasurement(frequency) {
            // 计算张力
            const tensionN = 4 * massDensity * Math.pow(spanLength/1000, 2) * Math.pow(frequency, 2);
            const tensionKg = tensionN / 9.8; // 转换为千克力
            
            // 显示结果
            resultStatus.textContent = '测量完成';
            resultStatus.style.color = 'var(--success)';
            resultValue.textContent = `${tensionKg.toFixed(2)} kg`;
            
            // 显示详细信息
            frequencyValue.textContent = `${frequency.toFixed(2)} Hz`;
            tensionValue.textContent = `${tensionKg.toFixed(2)} kg`;
            resultDetails.style.display = 'grid';
            
            // 添加成功动画
            resultValue.style.transform = 'scale(1.1)';
            setTimeout(() => {
                resultValue.style.transform = 'scale(1)';
            }, 300);
            
            // 保存测量记录
            addRecord({
                frequency: frequency,
                tensionKg: tensionKg,
                time: new Date().toLocaleTimeString()
            });
        }
        
        // 停止录制
        function stopRecording() {
            isRecording = false;
            measureButton.classList.remove('recording');
            measureButton.querySelector('.measure-button-text').textContent = '开始测量';
            setProgress(0);
            
            // 断开音频节点
            if (microphone) microphone.disconnect();
            if (scriptProcessor) scriptProcessor.disconnect();
            if (audioContext) audioContext.close();
        }
        
        // 实时绘制频谱
        function drawRealTimeSpectrum() {
            if (!analyser) return;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            const width = canvas.width / (window.devicePixelRatio || 1);
            const height = canvas.height / (window.devicePixelRatio || 1);
            
            // 清除画布
            canvasCtx.fillStyle = '#f8f9fa';
            canvasCtx.fillRect(0, 0, width, height);
            
            // 绘制频谱线
            canvasCtx.lineWidth = 2;
            canvasCtx.strokeStyle = '#3498db';
            canvasCtx.beginPath();
            
            const barWidth = width / dataArray.length;
            let x = 0;
            
            for (let i = 0; i < dataArray.length; i++) {
                const barHeight = (dataArray[i] / 255) * height;
                
                canvasCtx.moveTo(x, height);
                canvasCtx.lineTo(x, height - barHeight);
                
                x += barWidth;
            }
            
            canvasCtx.stroke();
            
            // 标记皮带振动频率范围
            const freqResolution = sampleRate / dataArray.length;
            const minIndex = Math.floor(MIN_FREQUENCY / freqResolution);
            const maxIndex = Math.floor(MAX_FREQUENCY / freqResolution);
            
            canvasCtx.fillStyle = 'rgba(52, 152, 219, 0.1)';
            canvasCtx.fillRect(
                (minIndex / dataArray.length) * width, 
                0, 
                ((maxIndex - minIndex) / dataArray.length) * width, 
                height
            );
            
            // 标记峰值
            let maxMag = 0;
            let maxIndex = 0;
            
            for (let i = 0; i < dataArray.length; i++) {
                if (dataArray[i] > maxMag) {
                    maxMag = dataArray[i];
                    maxIndex = i;
                }
            }
            
            if (maxMag > 10) {
                const freq = (maxIndex * sampleRate) / (2 * dataArray.length);
                const xPos = (maxIndex / dataArray.length) * width;
                const yPos = height - (maxMag / 255) * height;
                
                // 绘制峰值点
                canvasCtx.fillStyle = '#e74c3c';
                canvasCtx.beginPath();
                canvasCtx.arc(xPos, yPos, 5, 0, 2 * Math.PI);
                canvasCtx.fill();
                
                // 绘制频率标签
                canvasCtx.fillStyle = '#2c3e50';
                canvasCtx.font = '12px Arial';
                canvasCtx.fillText(`${freq.toFixed(1)} Hz`, xPos + 8, yPos - 5);
            }
        }
        
        // 设置进度环
        function setProgress(percent) {
            const circumference = 2 * Math.PI * 65;
            const offset = circumference - percent * circumference;
            progressCircle.style.strokeDashoffset = offset;
        }
        
        // 添加测量记录
        function addRecord(record) {
            measurementRecords.unshift(record);
            if (measurementRecords.length > 10) {
                measurementRecords = measurementRecords.slice(0, 10);
            }
            localStorage.setItem('tensionRecords', JSON.stringify(measurementRecords));
            updateRecordList();
        }
        
        // 更新记录列表
        function updateRecordList() {
            recordsGrid.innerHTML = '';
            recordCount.textContent = measurementRecords.length;
            
            if (measurementRecords.length === 0) {
                recordsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #7f8c8d;">暂无测量记录</div>';
                averageResult.style.display = 'none';
                return;
            }
            
            measurementRecords.forEach((record, index) => {
                const recordItem = document.createElement('div');
                recordItem.className = 'record-item';
                recordItem.innerHTML = `
                    <button class="record-delete" data-index="${index}">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="record-frequency">${record.frequency.toFixed(1)} Hz</div>
                    <div class="record-tension">${record.tensionKg.toFixed(2)} kg</div>
                `;
                recordsGrid.appendChild(recordItem);
            });
            
            // 计算平均值
            if (measurementRecords.length > 0) {
                const avgTension = measurementRecords.reduce((sum, record) => sum + record.tensionKg, 0) / measurementRecords.length;
                averageValue.textContent = `${avgTension.toFixed(2)} kg`;
                averageResult.style.display = 'block';
            }
            
            // 添加删除事件监听器
            document.querySelectorAll('.record-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    measurementRecords.splice(index, 1);
                    localStorage.setItem('tensionRecords', JSON.stringify(measurementRecords));
                    updateRecordList();
                });
            });
        }
        
        // 清空记录
        function clearRecords() {
            if (measurementRecords.length === 0) return;
            
            if (confirm('确定要清空所有测量记录吗？')) {
                measurementRecords = [];
                localStorage.setItem('tensionRecords', JSON.stringify(measurementRecords));
                updateRecordList();
            }
        }
        
        // 显示错误信息
        function showError(message) {
            resultStatus.innerHTML = message;
            resultStatus.style.color = 'var(--danger)';
            resultValue.textContent = '--';
            resultDetails.style.display = 'none';
        }
    </script>
</body>
</html>