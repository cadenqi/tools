<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>皮带张力检测工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a5276;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --border-radius: 16px;
            --header-height: 64px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: var(--dark);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding-top: var(--header-height);
            overflow-x: hidden;
        }
        
        /* 固定顶部导航 */
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--header-height);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 1.3rem;
        }
        
        .logo i {
            font-size: 1.6rem;
        }
        
        .nav-tabs {
            display: flex;
            gap: 5px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 30px;
            padding: 5px;
            overflow-x: auto;
            max-width: 70%;
        }
        
        .nav-tab {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .nav-tab.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* 主容器 */
        .container {
            max-width: 100%;
            padding: 20px;
            margin: 0 auto;
        }
        
        /* 标签页内容 */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 卡片样式 */
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:last-child {
            margin-bottom: 0;
        }
        
        .card h2 {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }
        
        .card h2 i {
            color: var(--secondary);
        }
        
        /* 表单元素 */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 0;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        /* 圆形测量按钮 */
        .measure-button-container {
            display: flex;
            justify-content: center;
            margin: 25px 0;
        }
        
        .measure-button {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), #2980b9);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .measure-button:active {
            transform: scale(0.95);
        }
        
        .measure-button.recording {
            background: linear-gradient(135deg, var(--danger), #c0392b);
            animation: pulse 1.5s infinite;
        }
        
        .measure-button i {
            font-size: 2.5rem;
            margin-bottom: 5px;
        }
        
        .measure-button-text {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .progress-ring {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            fill: none;
            stroke: rgba(255, 255, 255, 0.3);
            stroke-width: 4;
            stroke-dasharray: 440;
            stroke-dashoffset: 440;
            transition: stroke-dashoffset 0.3s;
        }
        
        /* 结果展示 */
        .result-card {
            text-align: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .result-value {
            font-size: 2.8rem;
            font-weight: 700;
            color: var(--secondary);
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .result-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .detail-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .detail-label {
            font-size: 0.85rem;
            color: #7f8c8d;
        }
        
        .detail-value {
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 5px;
            color: var(--primary);
        }
        
        /* 实时测量记录 */
        .live-records {
            margin-top: 20px;
        }
        
        .records-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .record-card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        
        .record-number {
            font-size: 0.8rem;
            color: #7f8c8d;
        }
        
        .record-tension {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin: 5px 0;
        }
        
        .record-frequency {
            font-size: 0.8rem;
            color: var(--secondary);
        }
        
        .average-result {
            background: #e8f4fc;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
        }
        
        .average-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .average-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--success);
            margin-top: 5px;
        }
        
        /* 频谱图 */
        #frequencyCanvas {
            width: 100%;
            height: 180px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-top: 15px;
        }
        
        /* 状态指示 */
        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            background: #f8f9fa;
            font-size: 0.95rem;
        }
        
        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: var(--danger);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* 权限提示图标 */
        .permission-info {
            position: relative;
            display: inline-flex;
            align-items: center;
            margin-left: 10px;
        }
        
        .permission-icon {
            color: var(--secondary);
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .permission-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            width: 200px;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 100;
        }
        
        .permission-info:hover .permission-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* 张力参考表格 */
        .tension-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.85rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .tension-table th, .tension-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        
        .tension-table th {
            background: var(--primary);
            color: white;
        }
        
        .tension-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .tension-note {
            margin-top: 15px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 12px;
            font-size: 0.85rem;
        }
        
        .tension-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 15px 0;
            font-size: 0.85rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        
        .legend-good {
            background: #d4edda;
        }
        
        .legend-acceptable {
            background: #fff3cd;
        }
        
        .legend-high {
            background: #f8d7da;
        }
        
        .legend-low {
            background: #e2e3e5;
        }
        
        .factors-list {
            margin-top: 15px;
        }
        
        .factor-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .factor-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        /* 使用说明 */
        .instructions {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 20px;
        }
        
        .instructions ol, .instructions ul {
            padding-left: 20px;
            margin: 15px 0;
        }
        
        .instructions li {
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .step-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            background: var(--secondary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
            font-size: 0.9rem;
        }
        
        /* 底部信息 */
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.8rem;
        }
        
        /* 响应式调整 */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .result-details {
                grid-template-columns: 1fr;
            }
            
            .records-grid {
                grid-template-columns: 1fr;
            }
            
            .tension-table {
                font-size: 0.75rem;
            }
            
            .tension-table th, .tension-table td {
                padding: 8px;
            }
            
            .result-value {
                font-size: 2.2rem;
            }
            
            .measure-button {
                width: 120px;
                height: 120px;
            }
            
            .measure-button i {
                font-size: 2rem;
            }
            
            .nav-tabs {
                max-width: 65%;
            }
            
            .nav-tab {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
        }
        
        @media (max-width: 360px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 12px;
            }
            
            .measure-button {
                width: 100px;
                height: 100px;
            }
            
            .measure-button i {
                font-size: 1.8rem;
            }
            
            .result-value {
                font-size: 2rem;
            }
        }
        
        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            max-width: 90%;
            width: 350px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .modal h3 {
            margin-bottom: 12px;
            color: var(--primary);
            font-size: 1.2rem;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .modal-buttons .btn {
            flex: 1;
            padding: 10px;
        }
        
        /* 按钮样式 */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: var(--secondary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
            width: 100%;
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-success:hover {
            background: #219653;
        }
        
        .btn-clear {
            background: var(--warning);
        }
        
        .btn-clear:hover {
            background: #e67e22;
        }
    </style>
</head>
<body>
    <!-- 固定顶部导航 -->
    <header>
        <div class="logo">
            <i class="fas fa-wave-square"></i>
            <span>张力检测</span>
        </div>
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="tool">检测工具</div>
            <div class="nav-tab" data-tab="tension-ref">张力参考</div>
            <div class="nav-tab" data-tab="instructions">使用说明</div>
        </div>
    </header>

    <!-- 主容器 -->
    <div class="container">
        <!-- 检测工具标签页 -->
        <div id="tool-tab" class="tab-content active">
            <!-- 状态指示器 -->
            <div class="status-indicator">
                <div id="resultStatus">准备测量皮带张力</div>
            </div>
            
            <!-- 参数设置卡片 -->
            <div class="card">
                <h2><i class="fas fa-cog"></i> 参数设置</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="spanLength">跨度长度 (mm)</label>
                        <input type="number" id="spanLength" value="800" step="1" min="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="massDensity">线性密度 (kg/m)</label>
                        <input type="number" id="massDensity" value="0.01" step="0.001" min="0.001">
                    </div>
                </div>
                
                <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                    自行车同步带线性密度通常为 0.01-0.02 kg/m
                </div>
            </div>
            
            <!-- 测量控制卡片 -->
            <div class="card">
                <h2><i class="fas fa-sliders-h"></i> 测量控制
                    <div class="permission-info">
                        <i class="fas fa-info-circle permission-icon"></i>
                        <div class="permission-tooltip">
                            需要麦克风权限来测量皮带振动频率。点击"开始测量"后请允许访问。
                        </div>
                    </div>
                </h2>
                
                <div class="measure-button-container">
                    <div class="measure-button" id="measureButton">
                        <svg class="progress-ring" width="140" height="140">
                            <circle class="progress-ring-circle" stroke="white" stroke-width="4" fill="transparent" r="65" cx="70" cy="70"/>
                        </svg>
                        <i class="fas fa-microphone"></i>
                        <div class="measure-button-text">开始测量</div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 15px;">
                    <button id="clearLiveRecords" class="btn btn-clear">
                        <i class="fas fa-eraser"></i> 清空当前记录
                    </button>
                </div>
            </div>
            
            <!-- 实时测量记录 -->
            <div class="card">
                <h2><i class="fas fa-history"></i> 实时测量记录</h2>
                
                <div class="live-records">
                    <div class="records-grid" id="liveRecordsGrid">
                        <!-- 实时测量记录将动态添加到这里 -->
                        <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #7f8c8d;">
                            暂无测量记录，点击上方按钮开始测量
                        </div>
                    </div>
                    
                    <div class="average-result" id="averageResult" style="display: none;">
                        <div class="average-label">4次测量平均值</div>
                        <div class="average-value" id="averageValue">-- kg</div>
                    </div>
                </div>
            </div>
            
            <!-- 结果展示卡片 -->
            <div class="card result-card">
                <h2><i class="fas fa-chart-line"></i> 最新测量结果</h2>
                <div id="resultValue" class="result-value">--</div>
                <div id="resultDetails" class="result-details" style="display: none;">
                    <div class="detail-item">
                        <div class="detail-label">检测频率</div>
                        <div id="frequencyValue" class="detail-value">-- Hz</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">皮带张力</div>
                        <div id="tensionKgValue" class="detail-value">-- kg</div>
                    </div>
                </div>
            </div>
            
            <!-- 频谱图卡片 -->
            <div class="card">
                <h2><i class="fas fa-waveform"></i> 频率频谱</h2>
                <canvas id="frequencyCanvas"></canvas>
            </div>
        </div>
        
        <!-- 张力参考标签页 -->
        <div id="tension-ref-tab" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-table"></i> 张力参考标准</h2>
                
                <div class="tension-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-good"></div>
                        <span>建议张力设置</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-acceptable"></div>
                        <span>可接受范围</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-high"></div>
                        <span>张力过高（不推荐）</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-low"></div>
                        <span>张力过低（危险）</span>
                    </div>
                </div>
                
                <table class="tension-table">
                    <thead>
                        <tr>
                            <th>频率 (Hz)</th>
                            <th>35 Hz</th>
                            <th>40 Hz</th>
                            <th>45 Hz</th>
                            <th>50 Hz</th>
                            <th>55 Hz</th>
                            <th>60 Hz</th>
                            <th>65 Hz</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>张力 (磅)</td>
                            <td class="legend-good">28 磅</td>
                            <td class="legend-good">32 磅</td>
                            <td class="legend-good">35 磅</td>
                            <td class="legend-good">40 磅</td>
                            <td class="legend-acceptable">43 磅</td>
                            <td class="legend-acceptable">45 磅</td>
                            <td class="legend-high">48 磅</td>
                        </tr>
                        <tr>
                            <td>张力 (kg)</td>
                            <td class="legend-good">13 kg</td>
                            <td class="legend-good">15 kg</td>
                            <td class="legend-good">16 kg</td>
                            <td class="legend-good">18 kg</td>
                            <td class="legend-acceptable">19 kg</td>
                            <td class="legend-acceptable">20 kg</td>
                            <td class="legend-high">22 kg</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="tension-note">
                    <h4><i class="fas fa-info-circle"></i> 使用说明</h4>
                    <ul>
                        <li><strong>建议张力设置</strong>：表示推荐的张力设置。</li>
                        <li><strong>可接受范围</strong>：可能需要在此范围内调节张力，但不得低于最小范围。</li>
                        <li><strong>张力过高</strong>：可能会对换挡性能、传动系统轴承寿命和系统效率产生负面影响。</li>
                        <li><strong>张力过低</strong>：不应低于最小张力，否则可能出现跳齿、缩短皮带寿命。</li>
                    </ul>
                    
                    <h4>应用范围</h4>
                    <ul>
                        <li><strong>内变速花鼓</strong>：中置电机电动自行车系统</li>
                        <li><strong>内变速花鼓</strong>：自行车、花鼓电机电动自行车</li>
                        <li><strong>非变速花鼓</strong>：MTB、变速箱、协力车、载货、单速</li>
                    </ul>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-question-circle"></i> 影响皮带张力的因素</h2>
                
                <div class="factors-list">
                    <div class="factor-item">
                        <div class="factor-title">1. 皮带类型和材料</div>
                        <div>不同材料和结构的皮带具有不同的弹性模量和线性密度，直接影响张力计算。</div>
                    </div>
                    
                    <div class="factor-item">
                        <div class="factor-title">2. 皮带长度和跨度</div>
                        <div>皮带越长，相同频率下的张力越小。跨度的准确测量对结果至关重要。</div>
                    </div>
                    
                    <div class="factor-item">
                        <div class="factor-title">3. 环境温度</div>
                        <div>温度变化会影响皮带的弹性特性，高温可能导致皮带松弛。</div>
                    </div>
                    
                    <div class="factor-item">
                        <div class="factor-title">4. 使用时间和磨损</div>
                        <div>随着使用时间的增加，皮带会逐渐拉伸和磨损，导致张力变化。</div>
                    </div>
                    
                    <div class="factor-item">
                        <div class="factor-title">5. 安装精度</div>
                        <div>皮带轮的对中度和平行度会影响皮带张力分布。</div>
                    </div>
                    
                    <div class="factor-item">
                        <div class="factor-title">6. 负载条件</div>
                        <div>不同负载条件下，皮带的实际工作张力会有所变化。</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 使用说明标签页 -->
        <div id="instructions-tab" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-book"></i> 使用说明</h2>
                
                <div class="instructions">
                    <h3>测量步骤</h3>
                    
                    <div class="step-card">
                        <div class="step-number">1</div>
                        <div>输入皮带参数（跨度长度和线性密度）</div>
                    </div>
                    
                    <div class="step-card">
                        <div class="step-number">2</div>
                        <div>点击圆形"开始测量"按钮，允许麦克风访问权限</div>
                    </div>
                    
                    <div class="step-card">
                        <div class="step-number">3</div>
                        <div>在安静环境中敲击皮带中央使其振动</div>
                    </div>
                    
                    <div class="step-card">
                        <div class="step-number">4</div>
                        <div>系统自动分析频率并计算张力，结果显示在屏幕上</div>
                    </div>
                    
                    <div class="step-card">
                        <div class="step-number">5</div>
                        <div>重复测量4次，系统会自动计算平均值</div>
                    </div>
                    
                    <h3>技术原理</h3>
                    <p>本工具基于弦振动理论，通过检测皮带振动频率计算张力：</p>
                    <p style="text-align: center; font-weight: bold; margin: 15px 0; background: #f8f9fa; padding: 10px; border-radius: 8px;">
                        T = 4 × μ × (L/1000)² × f²
                    </p>
                    <p>其中：</p>
                    <ul>
                        <li><strong>T</strong> - 皮带张力 (N)</li>
                        <li><strong>μ</strong> - 皮带线性密度 (kg/m)</li>
                        <li><strong>L</strong> - 皮带跨度长度 (mm)，转换为米需要除以1000</li>
                        <li><strong>f</strong> - 振动频率 (Hz)，通过敲击皮带产生的振动频率</li>
                    </ul>
                    
                    <h3>声音过滤技术</h3>
                    <p>本工具采用以下技术过滤杂音，只检测皮带振动：</p>
                    <ul>
                        <li><strong>频率范围限制</strong>：只分析20-1000Hz范围内的频率，过滤人声和其他高频噪声</li>
                        <li><strong>幅度阈值</strong>：只有超过特定幅度的信号才被认为是有效振动</li>
                        <li><strong>短时测量</strong>：2秒的测量时间减少环境噪声干扰</li>
                        <li><strong>峰值检测</strong>：识别最明显的频率峰值，忽略背景噪声</li>
                    </ul>
                    
                    <h3>麦克风权限设置</h3>
                    <div class="permission-hint">
                        <p>如果无法访问麦克风，请按以下步骤设置：</p>
                        <ol>
                            <li>点击浏览器右上角的设置菜单</li>
                            <li>选择"设置" → "网站权限" → "麦克风"</li>
                            <li>找到本网站并设置为"允许"</li>
                            <li>刷新页面后重试</li>
                        </ol>
                    </div>
                    
                    <h3>注意事项</h3>
                    <ul>
                        <li>确保在安静环境中测量，避免背景噪声干扰</li>
                        <li>敲击皮带中央以获得准确的基频振动</li>
                        <li>测量结果仅供参考，关键应用请使用专业设备验证</li>
                        <li>不同浏览器和设备可能影响测量精度</li>
                        <li>建议进行多次测量取平均值以提高准确性</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 权限请求模态框 -->
    <div id="permissionModal" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-microphone"></i> 麦克风权限请求</h3>
            <p>皮带张力检测工具需要访问您的麦克风以测量皮带振动频率。</p>
            <p>请点击"允许"以继续使用本应用。</p>
            <div class="modal-buttons">
                <button id="denyPermission" class="btn btn-danger">拒绝</button>
                <button id="grantPermission" class="btn btn-success">允许</button>
            </div>
        </div>
    </div>
    
    <footer>
        <p>基于Web Audio API的皮带张力检测工具 | 开发原理：弦振动频率分析法</p>
        <p>© 2023 工业测量工具 | 仅供技术参考</p>
    </footer>

    <script>
        // 全局变量
        let audioContext;
        let analyser;
        let microphone;
        let scriptProcessor;
        let isRecording = false;
        const sampleRate = 44100;
        const fftSize = 4096;
        const bufferDuration = 2; // 缩短测量时间至2秒
        let permissionRequested = false;
        let liveRecords = []; // 实时测量记录
        
        // DOM元素
        const measureButton = document.getElementById('measureButton');
        const resultStatus = document.getElementById('resultStatus');
        const resultValue = document.getElementById('resultValue');
        const resultDetails = document.getElementById('resultDetails');
        const frequencyValue = document.getElementById('frequencyValue');
        const tensionKgValue = document.getElementById('tensionKgValue');
        const canvas = document.getElementById('frequencyCanvas');
        const canvasCtx = canvas.getContext('2d');
        const navTabs = document.querySelectorAll('.nav-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const permissionModal = document.getElementById('permissionModal');
        const grantPermissionBtn = document.getElementById('grantPermission');
        const denyPermissionBtn = document.getElementById('denyPermission');
        const liveRecordsGrid = document.getElementById('liveRecordsGrid');
        const averageResult = document.getElementById('averageResult');
        const averageValue = document.getElementById('averageValue');
        const clearLiveRecordsBtn = document.getElementById('clearLiveRecords');
        const progressCircle = document.querySelector('.progress-ring-circle');
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            setupCanvas();
            setupEventListeners();
        });
        
        // 设置Canvas尺寸
        function setupCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvasCtx.scale(dpr, dpr);
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 导航标签切换
            navTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    
                    // 更新活动标签
                    navTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // 显示对应内容
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${tabId}-tab`) {
                            content.classList.add('active');
                        }
                    });
                });
            });
            
            // 测量按钮事件
            measureButton.addEventListener('click', function() {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            });
            
            // 权限模态框按钮
            grantPermissionBtn.addEventListener('click', () => {
                permissionModal.style.display = 'none';
                permissionRequested = true;
                startRecording();
            });
            
            denyPermissionBtn.addEventListener('click', () => {
                permissionModal.style.display = 'none';
                resultStatus.textContent = '需要麦克风权限才能进行测量';
                resultStatus.style.color = 'var(--danger)';
                permissionRequested = true;
            });
            
            // 清空实时记录按钮
            clearLiveRecordsBtn.addEventListener('click', clearLiveRecords);
            
            // 窗口调整大小时重置Canvas
            window.addEventListener('resize', setupCanvas);
        }
        
        // 开始录制
        async function startRecording() {
            // 验证输入
            const L = parseFloat(document.getElementById('spanLength').value);
            const mu = parseFloat(document.getElementById('massDensity').value);
            
            if (!L || L <= 0) {
                showError('请输入有效的跨度长度（大于0）');
                return;
            }
            
            if (!mu || mu <= 0) {
                showError('请输入有效的线性密度（大于0）');
                return;
            }
            
            try {
                // 请求麦克风权限并创建音频上下文
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // 只在未请求过权限时显示模态框
                if (!permissionRequested) {
                    if (navigator.permissions) {
                        const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
                        
                        if (permissionStatus.state === 'prompt') {
                            permissionModal.style.display = 'flex';
                            return;
                        } else if (permissionStatus.state === 'denied') {
                            showError('麦克风访问被拒绝。请在浏览器设置中允许麦克风权限。');
                            permissionRequested = true;
                            return;
                        }
                    } else {
                        permissionModal.style.display = 'flex';
                        return;
                    }
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false,
                        sampleRate: sampleRate
                    } 
                });
                
                // 创建分析节点
                microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = fftSize;
                analyser.smoothingTimeConstant = 0.3; // 降低平滑系数以提高响应速度
                
                // 创建脚本处理器用于处理音频数据
                scriptProcessor = audioContext.createScriptProcessor(fftSize, 1, 1);
                
                // 连接节点
                microphone.connect(analyser);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);
                
                // 设置音频处理回调
                let audioData = [];
                let startTime = Date.now();
                
                scriptProcessor.onaudioprocess = (e) => {
                    if (isRecording) {
                        const input = e.inputBuffer.getChannelData(0);
                        audioData = audioData.concat(Array.from(input));
                        
                        // 实时绘制频谱
                        drawRealTimeSpectrum();
                        
                        // 更新进度环
                        const elapsed = Date.now() - startTime;
                        const progress = elapsed / (bufferDuration * 1000);
                        setProgress(progress);
                        
                        // 检查是否超时
                        if (elapsed > bufferDuration * 1000) {
                            stopRecording(audioData);
                        }
                    }
                };
                
                // 开始录制
                isRecording = true;
                measureButton.classList.add('recording');
                measureButton.querySelector('.measure-button-text').textContent = '停止测量';
                resultStatus.innerHTML = '<span class="recording-indicator"></span> 正在录制... 请敲击皮带中央';
                resultValue.textContent = '--';
                resultDetails.style.display = 'none';
                
            } catch (err) {
                console.error('录音错误:', err);
                let errorMessage = '无法访问麦克风: ';
                
                if (err.name === 'NotAllowedError') {
                    errorMessage += '权限被拒绝。';
                    if (!permissionRequested) {
                        permissionModal.style.display = 'flex';
                    } else {
                        errorMessage += '请在浏览器设置中允许麦克风访问。';
                    }
                } else if (err.name === 'NotFoundError') {
                    errorMessage += '未找到麦克风设备。请检查设备连接。';
                } else if (err.name === 'NotSupportedError') {
                    errorMessage += '浏览器不支持音频录制功能。';
                } else {
                    errorMessage += err.message;
                }
                
                showError(errorMessage);
                permissionRequested = true;
            }
        }
        
        // 停止录制
        function stopRecording(audioData = []) {
            isRecording = false;
            measureButton.classList.remove('recording');
            measureButton.querySelector('.measure-button-text').textContent = '开始测量';
            setProgress(0);
            
            // 断开音频节点
            if (microphone) microphone.disconnect();
            if (scriptProcessor) scriptProcessor.disconnect();
            if (audioContext) audioContext.close();
            
            // 处理录制的音频数据
            if (audioData.length === 0) {
                showError('无音频数据，请重试');
                return;
            }
            
            // 分析频率
            const frequency = analyzeFrequency(audioData);
            
            if (frequency && frequency > 20 && frequency < 1000) {
                // 计算张力
                const L = parseFloat(document.getElementById('spanLength').value);
                const mu = parseFloat(document.getElementById('massDensity').value);
                // 注意：L是毫米，需要转换为米
                const tensionN = 4 * mu * Math.pow(L/1000, 2) * Math.pow(frequency, 2);
                const tensionKg = tensionN / 9.8; // 转换为千克力
                
                // 显示结果
                resultStatus.textContent = '测量完成';
                resultStatus.style.color = 'var(--success)';
                resultValue.textContent = `${tensionKg.toFixed(2)} kg`;
                
                // 显示详细信息
                frequencyValue.textContent = `${frequency.toFixed(2)} Hz`;
                tensionKgValue.textContent = `${tensionKg.toFixed(2)} kg`;
                resultDetails.style.display = 'grid';
                
                // 添加成功动画
                resultValue.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    resultValue.style.transform = 'scale(1)';
                }, 300);
                
                // 保存到实时测量记录
                addLiveRecord({
                    frequency: frequency,
                    length: L,
                    density: mu,
                    tensionN: tensionN,
                    tensionKg: tensionKg,
                    time: new Date().toLocaleTimeString()
                });
                
            } else {
                showError('未检测到有效频率，请重试。确保在安静环境中敲击皮带。');
            }
        }
        
        // 分析频率 - 优化版，过滤杂音
        function analyzeFrequency(audioData) {
            const n = Math.min(fftSize, audioData.length);
            const real = new Float32Array(n);
            const imag = new Float32Array(n);
            
            // 应用汉宁窗减少频谱泄漏
            for (let i = 0; i < n; i++) {
                const window = 0.5 * (1 - Math.cos(2 * Math.PI * i / (n - 1)));
                real[i] = audioData[i] * window;
                imag[i] = 0;
            }
            
            // 执行FFT
            fft(real, imag);
            
            // 寻找最大幅度的频率
            let maxMag = 0;
            let maxIndex = 0;
            
            // 只分析20Hz到1000Hz的频率范围（皮带振动频率范围）
            const minFreqIndex = Math.floor(20 * n / sampleRate);
            const maxFreqIndex = Math.floor(1000 * n / sampleRate);
            
            for (let i = minFreqIndex; i < Math.min(maxFreqIndex, n/2); i++) {
                const mag = Math.sqrt(real[i] * real[i] + imag[i] * imag[i]);
                if (mag > maxMag) {
                    maxMag = mag;
                    maxIndex = i;
                }
            }
            
            // 计算频率
            const freqResolution = sampleRate / n;
            const frequency = maxIndex * freqResolution;
            
            // 只有幅度足够大的频率才被认为是有效信号
            // 调整阈值以过滤杂音
            const threshold = 0.02; // 提高阈值以减少环境噪声影响
            
            // 检查频率是否在合理范围内（皮带振动通常在30-150Hz）
            if (maxMag > threshold && frequency >= 30 && frequency <= 150) {
                return frequency;
            }
            
            return null;
        }
        
        // FFT实现（Cooley-Tukey算法）
        function fft(real, imag) {
            const n = real.length;
            if (n <= 1) return;
            
            // 分离偶数和奇数索引
            const evenReal = new Float32Array(n / 2);
            const evenImag = new Float32Array(n / 2);
            const oddReal = new Float32Array(n / 2);
            const oddImag = new Float32Array(n / 2);
            
            for (let i = 0; i < n / 2; i++) {
                evenReal[i] = real[2 * i];
                evenImag[i] = imag[2 * i];
                oddReal[i] = real[2 * i + 1];
                oddImag[i] = imag[2 * i + 1];
            }
            
            // 递归计算
            fft(evenReal, evenImag);
            fft(oddReal, oddImag);
            
            // 合并结果
            for (let k = 0; k < n / 2; k++) {
                const theta = -2 * Math.PI * k / n;
                const wr = Math.cos(theta);
                const wi = Math.sin(theta);
                
                const tempReal = wr * oddReal[k] - wi * oddImag[k];
                const tempImag = wr * oddImag[k] + wi * oddReal[k];
                
                real[k] = evenReal[k] + tempReal;
                imag[k] = evenImag[k] + tempImag;
                real[k + n / 2] = evenReal[k] - tempReal;
                imag[k + n / 2] = evenImag[k] - tempImag;
            }
        }
        
        // 实时绘制频谱
        function drawRealTimeSpectrum() {
            if (!analyser) return;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            const width = canvas.width / (window.devicePixelRatio || 1);
            const height = canvas.height / (window.devicePixelRatio || 1);
            
            // 清除画布
            canvasCtx.fillStyle = '#f8f9fa';
            canvasCtx.fillRect(0, 0, width, height);
            
            // 绘制频谱线
            canvasCtx.lineWidth = 2;
            canvasCtx.strokeStyle = '#3498db';
            canvasCtx.beginPath();
            
            const barWidth = width / dataArray.length;
            let x = 0;
            
            for (let i = 0; i < dataArray.length; i++) {
                const barHeight = (dataArray[i] / 255) * height;
                
                canvasCtx.moveTo(x, height);
                canvasCtx.lineTo(x, height - barHeight);
                
                x += barWidth;
            }
            
            canvasCtx.stroke();
            
            // 标记峰值
            let maxIndex = 0;
            let maxValue = 0;
            
            for (let i = 0; i < dataArray.length; i++) {
                if (dataArray[i] > maxValue) {
                    maxValue = dataArray[i];
                    maxIndex = i;
                }
            }
            
            if (maxValue > 10) {
                const freq = (maxIndex * sampleRate) / (2 * dataArray.length);
                const xPos = (maxIndex / dataArray.length) * width;
                const yPos = height - (maxValue / 255) * height;
                
                // 绘制峰值点
                canvasCtx.fillStyle = '#e74c3c';
                canvasCtx.beginPath();
                canvasCtx.arc(xPos, yPos, 5, 0, 2 * Math.PI);
                canvasCtx.fill();
                
                // 绘制频率标签
                canvasCtx.fillStyle = '#2c3e50';
                canvasCtx.font = '12px Arial';
                canvasCtx.fillText(`${freq.toFixed(1)} Hz`, xPos + 8, yPos - 5);
            }
        }
        
        // 设置进度环
        function setProgress(percent) {
            const circumference = 2 * Math.PI * 65;
            const offset = circumference - percent * circumference;
            progressCircle.style.strokeDashoffset = offset;
        }
        
        // 添加实时测量记录
        function addLiveRecord(record) {
            liveRecords.push(record);
            updateLiveRecordsDisplay();
            
            // 如果达到4次测量，计算平均值
            if (liveRecords.length >= 4) {
                calculateAverage();
            }
        }
        
        // 更新实时测量记录显示
        function updateLiveRecordsDisplay() {
            liveRecordsGrid.innerHTML = '';
            
            if (liveRecords.length === 0) {
                liveRecordsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #7f8c8d;">暂无测量记录，点击上方按钮开始测量</div>';
                averageResult.style.display = 'none';
                return;
            }
            
            liveRecords.forEach((record, index) => {
                const recordCard = document.createElement('div');
                recordCard.className = 'record-card';
                recordCard.innerHTML = `
                    <div class="record-number">测量 ${index + 1}</div>
                    <div class="record-tension">${record.tensionKg.toFixed(2)} kg</div>
                    <div class="record-frequency">${record.frequency.toFixed(1)} Hz</div>
                `;
                liveRecordsGrid.appendChild(recordCard);
            });
        }
        
        // 计算4次测量的平均值
        function calculateAverage() {
            if (liveRecords.length < 4) return;
            
            // 取最近4次测量
            const recentRecords = liveRecords.slice(-4);
            
            // 计算张力平均值
            const totalTension = recentRecords.reduce((sum, record) => sum + record.tensionKg, 0);
            const averageTension = totalTension / 4;
            
            // 显示平均值
            averageValue.textContent = `${averageTension.toFixed(2)} kg`;
            averageResult.style.display = 'block';
        }
        
        // 清空实时记录
        function clearLiveRecords() {
            liveRecords = [];
            updateLiveRecordsDisplay();
        }
        
        // 显示错误信息
        function showError(message) {
            resultStatus.innerHTML = message;
            resultStatus.style.color = 'var(--danger)';
            resultValue.textContent = '--';
            resultDetails.style.display = 'none';
        }
    </script>
</body>
</html>